<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Venta Perfil</title>
    <link rel="stylesheet" href="../css/ventaPerfil.css">
    <div id="navbar"></div>
    <script>
        // Cargar el navbar dinámicamente
        fetch('navbar.html')
            .then(response => response.text())
            .then(data => {
                // Insertar el contenido del navbar en el elemento con id "navbar"
                document.getElementById('navbar').innerHTML = data;

                // Una vez que el contenido esté cargado, modificar el navbar según la página actual
                marcarEnlaceActivo();
            })
            .catch(error => console.error('Error cargando el navbar:', error));

        // Función para marcar el enlace activo
        function marcarEnlaceActivo() {
            // Obtener solo el nombre del archivo de la página actual (sin directorios)
            const currentFile = window.location.pathname.split('/').pop();

            // Seleccionar todos los enlaces dentro del elemento <nav>
            const navLinks = document.querySelectorAll("#navbar nav ul li a");

            // Comparar el nombre del archivo con el atributo href de los enlaces
            navLinks.forEach(link => {
                if (link.getAttribute("href") === currentFile) {
                    link.classList.add("active");
                }
            });
        }
    </script>
</head>
<body>
    <div class="especificaciones-container">

        <!-- Especificaciones -->
        <div class="especificaciones-img">
            <div class="especificacion-item">
                <img src="../Img/kilometraje.png" class="especificacion-img" alt="Kilometraje">
                <h2 class="especificacion-titulo">Kilometraje:</h2>
                <div class="especificacion-texto" id="km"></div>
            </div>
            <div class="especificacion-item">
                <img src="../Img/transmision.png" class="especificacion-img" alt="Transmisión">
                <h2 class="especificacion-titulo">Transmision:</h2>
                <div class="especificacion-texto" id="transmision"></div>
            </div>
            <div class="especificacion-item">
                <img src="../Img/gas.png" class="especificacion-img" alt="Gas">
                <h2 class="especificacion-titulo">Combustible:</h2>
                <div class="especificacion-texto" id="gas"></div>
            </div>
            <div class="especificacion-item">
                <img src="../Img/carroceria.png" class="especificacion-img" alt="Carrocería">
                <h2 class="especificacion-titulo">Carroceria:</h2>
                <div class="especificacion-texto" id="carroceria"></div>
            </div>
        </div>
    </div>
    <div class="fotoAuto" id="fotoAuto"></div>

    <div id="detalleAuto" class="detalleAuto"></div>

    <div class="compra">
        <div class="precio-compra"></div>
        <button>Comprar</button>
    </div>
    <div id="customModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="cerrarModal()">&times;</span>
            <p id="modalMessage"></p>
            <button onclick="redirigirRegistro()">Registrarse</button>
        </div>
    </div>
</body>

<script>
    // Obtiene el parámetro 'id' de la URL
    function obtenerIdAuto() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('id'); // Ejemplo: ?id=123
    }

    // Hace una solicitud a la API para obtener los datos del auto
    async function obtenerDatosAuto(id) {
        const url = `https://localhost:7129/MotorsApi/ventaFlota/flotaDetalle/${id}`;
        try {
            const respuesta = await fetch(url);
            if (!respuesta.ok) {
                throw new Error(`Error en la respuesta: ${respuesta.status} ${respuesta.statusText}`);
            }
            return await respuesta.json(); // Devuelve los datos como JSON
        } catch (error) {
            console.error('Error al obtener los datos del auto:', error);
            return null; // Devuelve null en caso de error
        }
    }

    // Muestra los datos del auto en la página
    function mostrarAuto(auto) {
        const fotoAuto = document.getElementById('fotoAuto');
        const detalleAuto = document.getElementById('detalleAuto');
        const precioCompra = document.querySelector('.precio-compra'); // Nuevo selector para el precio en la sección de compra

        if (Array.isArray(auto) && auto.length > 0) {
            const datosAuto = auto[0]; // Accedemos al primer elemento del array

            console.log('Datos del auto:', datosAuto);

            // Actualizamos la imagen del auto
            fotoAuto.innerHTML = `
                <img src="${datosAuto.foto}" alt="Foto de ${datosAuto.marca} ${datosAuto.modelo}">
            `;

            // Actualizamos el nombre y marca del auto
            detalleAuto.innerHTML = `
                <h2>${datosAuto.marca || 'N/A'} ${datosAuto.modelo || 'N/A'}</h2>
            `;

            // Asignar los datos obtenidos a los divs correspondientes
            document.getElementById('km').innerText = `${datosAuto.km || 'N/A'} km`;
            document.getElementById('transmision').innerText = datosAuto.transmision || 'N/A';
            document.getElementById('gas').innerText = datosAuto.tipo_gas || 'N/A';
            document.getElementById('carroceria').innerText = datosAuto.carroceria || 'N/A';

            // Agregar el precio en el div de compra
            precioCompra.innerHTML = `<strong>Precio:</strong> $${datosAuto.precio || 'N/A'}`;
        } else {
            // Mostramos un mensaje de error si no hay datos
            detalleAuto.innerHTML = '<p>No se pudo cargar la información del auto.</p>';
        }
    }


    // Función principal que carga los datos al iniciar la página
    async function cargarAuto() {
        const idAuto = obtenerIdAuto(); // Obtenemos el ID desde la URL
        if (idAuto) {
            const auto = await obtenerDatosAuto(idAuto); // Obtenemos los datos del auto
            if (auto) {
                mostrarAuto(auto); // Mostramos los datos del auto
            } else {
                console.error('No se pudieron obtener los datos del auto.');
            }
        } else {
            console.error('El parámetro ID no está presente en la URL.');
        }
    }

    // Ejecutamos la carga de datos al cargar la página
    cargarAuto();
    document.querySelector('.compra button').addEventListener('click', async () => {
    const userId = localStorage.getItem('userId'); // Verifica si el usuario está logueado
    const id_cliente = 1;
    if (!id_cliente) {
        mostrarModal("No tienes una cuenta. Regístrate para poder realizar una compra.");
    } else {
        // Lógica para enviar la compra a la base de datos
        try {
            const id = obtenerIdAuto(); // Obtener el ID del auto desde la URL (con el nombre 'id' en vez de 'idAuto')

            // Aquí usas 'id' en lugar de 'idAuto'
            const responseFlota = await fetch(`https://localhost:7129/MotorsApi/ventaFlota/flotaDetalle/${id}`);
            
            if (!responseFlota.ok) {
                throw new Error("Error al obtener los datos del auto");
            }
            
            const autoData = await responseFlota.json();
            
            if (!autoData || autoData.length === 0) {
                mostrarModal("No se encontraron datos del auto.");
                return;
            }
            
            // Supongamos que el primer elemento tiene los datos correctos
            const { placa, precio } = autoData[0];
        
            const response = await fetch(`https://localhost:7129/MotorsApi/ventaFlota/vendido`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ id_cliente, precio, placa})
            });

            if (response.ok) {
                mostrarModal("Compra realizada con éxito.");
            } else {
                mostrarModal("Hubo un problema al procesar la compra.");
            }
        } catch (error) {
            console.error('Error en la solicitud:', error);
            mostrarModal("Ocurrió un error al intentar procesar la compra.");
        }
    }
    });


function mostrarModal(message) {
    document.getElementById('modalMessage').innerText = message;
    document.getElementById('customModal').style.display = 'block';
}

function cerrarModal() {
    document.getElementById('customModal').style.display = 'none';
}

function redirigirRegistro() {
    window.location.href = 'register.html';
}
    
</script>
</html>